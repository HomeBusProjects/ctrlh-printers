<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>PDX Hackerspace Dashboard</title>
        <meta name="viewport" content="width=device-width">
        <meta name="description" content="Portland's Hackerspace. Check out our website calendar for our weekly open house and all other events open to the public.">
        <meta name="robots" content="noindex">
        <script src="https://kit.fontawesome.com/0556c42d44.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css" integrity="sha384-degZUV6f5Qw/AGD0Kq6kEC7j8V6h+IWPfm+AJ+2q3gaTFa9U4fu/9u3Egh7xOYE4" crossorigin="anonymous">
        <style>
            html {
                font-size: 16px;
            }
            .hr-green {
                color: green !important;
            }
            time,
            #last_updated {
                font-size: small;
                font-style: italic;
            }
            body { 
                padding-top: 65px;
            }
            body, .list-group-item {
                background-color: white; 
                color: black; 
            }
            .progress-bar { color: black; }
            @media screen and (prefers-color-scheme: dark) {
                img {
                    opacity: .75;
                    transition: opacity .5s ease-in-out;
                }
                img:hover {
                    opacity: 1;
                }
                body, .list-group-item {
                    background-color: black; 
                    color: white; 
                }
            }
        </style>
    </head>
    <body>
        <div class="container-fluid">

	      <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
	        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
	          <span class="navbar-toggler-icon"></span>
	        </button>
	        <a class="navbar-brand activity-bar" href="#">PDX Hackerspace</a>
	        <div class="collapse navbar-collapse" id="navbarSupportedContent">
		  <ul class="navbar-nav mr-auto">
		    <li class="nav-item">
		      <a href="#3d-printers" class='nav-link'>3D Printers</a>
		    </li>
		    <li class="nav-item">
		      <a href="#weather" class='nav-link'>Weather</a>
		    </li>
		    <li class="nav-item">
		      <a href="#air-quality" class='nav-link'>Air Quality</a>
		    </li>
		  </ul>

                  <span id='last_updated' class='navbar-text'>
		    Last updated: <span id='last_updated_container'></span>
		  </span>

	        </div>
	      </nav>

	</div>
        <div class="container-fluid">
            <div class='row'>
                <div class='col-sm-4'>
		  <div id='c0603a32-7817-4922-b661-2a6be57b6bd0'>
		    <h2>Dremel Cam</h2>
		    <a href='' data-toggle='lightbox'>
                      <img src='test-pattern.jpg' class='img-fluid img-thumbnail' style='object-fit: contain'>
		    </a>
		  </div>
                  <div id='7bfff065-f2e8-406d-b8d1-734a84c4c222'>
                    <h3>
                        Dremel
                    </h3>
                    <h6 class='status'></h6>
                    <div class='job' style='display: none'>
                        <ul class='list-group'>
                            <li class='list-group-item'>Filename:
                                <span class='filename'></span>
                            </li>
                            <li class='list-group-item'><span class='print-progress progress-bar' role='progressbar' style='width: 0%;'></span></li>
                            <li class='list-group-item'>Time Remaining:
                                <span class='print-time'></span>
                                of
                                <span class='print-time-remaining'></span>
                                sec
                            </li>
                        </ul>
                        <table class='table'>
                            <tr>
                                <th>temp</th>
                                <th>actual</th>
                                <th>target</th>
                            </tr>
                            <tr>
                                <td>tool</td>
                                <td>
                                    <span class='tool-temp'></span>°C</td>
                                <td>
                                    <span class='tool-temp-target'></span>°C</td>
                            </tr>
                            <tr>
                                <td>bed</td>
                                <td>
                                    <span class='bed-temp'></span>°C</td>
                                <td>
                                    <span class='bed-temp-target'></span>°C</td>
                            </tr>
                        </table>
                    </div>
                    <!-- #dremel-job -->
                  </div>
                </div><!-- dremel -->

                <div class='col-sm-4'>
		  <div id='ad543d04-871f-4fde-9e0c-e05ca4cff288'>
		  <h2>Prusa-1 Cam</h2>
		    <a href='' data-toggle='lightbox'>
                      <img src='test-pattern.jpg' class='img-fluid img-thumbnail' style='object-fit: contain'>
		    </a>
		  </div>

                  <div id='6ab73b55-006b-4a95-adaa-1b9e34c85d46'>
                    <h3>
                        Prusa 1
                    </h3>
                    <h6 class='status'></h6>
                    <div class='job' style='display: none'>
                        <ul class='list-group'>
                            <li class='list-group-item'>Filename:
                                <span class='filename text-truncate'></span>
                            </li>
                            <li class='list-group-item'><span class='print-progress progress-bar' role='progressbar' style='width: 0%;'></span></li>
                            <li class='list-group-item'>Time Remaining:
                                <span class='print-time'></span>
                                of
                                <span class='print-time-remaining'></span>
                                sec</li>
                        </ul>
                    </div>
                    <table class='table'>
                        <tr>
                            <th>temp</th>
                            <th>actual</th>
                            <th>target</th>
                        </tr>
                        <tr>
                            <td>tool</td>
                            <td>
                                <span class='tool-temp'></span>°C</td>
                            <td>
                                <span class='tool-temp-target'></span>°C</td>
                        </tr>
                        <tr>
                            <td>bed</td>
                            <td>
                                <span class='bed-temp'></span>°C</td>
                            <td>
                                <span class='bed-temp-target'></span>°C</td>
                        </tr>
                    </table>
                  </div>
                </div><!-- prusa-1 -->

                <div class='col-sm-4'>
		  <div id='efcf12d3-3f10-4f16-9cfd-e39b5c683b14'>
		  <h2>Prusa-2 Cam</h2>
		    <a href='' data-toggle='lightbox'>
                      <img src='test-pattern.jpg' class='img-fluid img-thumbnail' style='object-fit: contain'>
		    </a>
		  </div>

                  <div id='34a8cf9b-1c94-4554-8fad-ddb616b0f07f'>
                    <h3>
                        Prusa 2
                    </h3>
                    <h6 class='status'></h6>
                    <div class='job' style='display: none'>
                        <ul class='list-group'>
                            <li class='list-group-item'>Filename:
                                <span class='filename text-truncate'></span>
                            </li>
                            <li class='list-group-item'><span class='print-progress progress-bar' role='progressbar' style='width: 0%;'></span></li>
                            <li class='list-group-item'>Time Remaining:
                                <span class='print-time'></span>
                                of
                                <span class='print-time-remaining'></span>
                                sec</li>
                        </ul>
                    </div>
                    <table class='table'>
                        <tr>
                            <th>temp</th>
                            <th>actual</th>
                            <th>target</th>
                        </tr>
                        <tr>
                            <td>tool</td>
                            <td>
                                <span class='tool-temp'></span>°C</td>
                            <td>
                                <span class='tool-temp-target'></span>°C</td>
                        </tr>
                        <tr>
                            <td>bed</td>
                            <td>
                                <span class='bed-temp'></span>°C</td>
                            <td>
                                <span class='bed-temp-target'></span>°C</td>
                        </tr>
                    </table>
                  </div>
                </div><!-- prusa-2 -->
            </div><!-- row -->


            <hr class='hr'/>

            <div class='row'>
                <div class='col'>
                    <h2 id='weather'>Weather</h2>
                    <h3>
                        OpenWeatherMap
                    </h3>
                    <p id='691faad6-bad4-4c87-838b-091ce650e4d4'></p>
                    <h3>
                        ^H Weather Station
                    </h3>
                    <p id='ea52198c-6162-4ea8-9e19-2f99bcfb4462'></p>
                </div>
                <!-- col -->
                <div class='col'>
                    <h2 id='air-quality'>Air Quality</h2>
                    <p id='aqi'></p>
                </div>
                <!-- col -->
            </div>
            <!-- row -->

            <div class='row'>
                <div class='col'>
                    <i>Want to hack this?</i>
                    Source is at
                    <a href='https://github.com/romkey/ctrlh-printers'>https://github.com/romkey/ctrlh-printers</a>
                </div>
            </div>
        </div>

        <script src='https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js' type='text/javascript'></script>
        <script src='https://code.jquery.com/jquery-3.2.1.slim.min.js' integrity='sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN' crossorigin='anonymous'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.6.7/jquery.timeago.min.js' integrity='sha384-bIExnxLHdrb4/5cUciUyC490hqkTPFw6V1eUbG0gpKQ67B3dsT6KOdXvl5RycCM6' crossorigin='anonymous'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js' integrity='sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q' crossorigin='anonymous'></script>
        <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js' integrity='sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl' crossorigin='anonymous'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js' integrity='sha384-bqIl0+8hxcMpOFf8O3ffwAy5qTUbFPyuNFytX/omkD4RDPMOBtt/uV6Lqlw7sljM' crossorigin='anonymous'></script>
        <script src='https://ctrlh-printers.romkey.com/credentials.js'></script>
	<script type='text/javascript'>
	// enable lightbox
	$(document).on('click', '[data-toggle="lightbox"]', function(event) {
                event.preventDefault();
                $(this).ekkoLightbox();
	});
	
            // MQTT dependencies should really be hidden within a someday-to-be-implemented Homebus library. For now we call NQTT directly
	    // credentials and connection information loaded from a separate Javascript file so that we don't check them into Github
	    // they're still out in the wild. MQTT connection is limited to read-only access to a few specific topics.
            client = new Paho.Client(credentials.MQTT_SERVER, credentials.MQTT_PORT, credentials.MQTT_UUID + new Date().getTime());
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            mqtt_connect();

            function onConnect() {
                client.subscribe('homebus/device/+/org.homebus.experimental.3dprinter'); 
                client.subscribe('homebus/device/+/org.homebus.experimental.image'); 
                client.subscribe('homebus/device/+/org.homebus.experimental.weather'); 
                client.subscribe('homebus/device/+/org.homebus.experimental.aqi'); 
            }

            function mqtt_connect() {
                var options = {
                    useSSL: true,
                    userName: credentials.MQTT_USERNAME,
                    password: credentials.MQTT_PASSWORD,
                    onSuccess: onConnect,
                    onFailure: doFail,
                    reconnect: true
                };
                console.log("mqtt connect");
                client.connect(options);
            }
            function doFail(e) {
                console.log(e);
                console.log("doFail");
            }
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("onConnectionLost:" + responseObject.errorMessage);
                }
                console.log("connection lost");
            }
            // shamelessly taken from https://stackoverflow.com/questions/15900485/correct-way-to-convert-size-in-bytes-to-kb-mb-gb-in-javascript
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) {
                    return '0 Bytes';
                }
                const k = 1024;
                const dm = decimals < 0
                    ? 0
                    : decimals;
                const sizes = [
                    'Bytes',
                    'KB',
                    'MB',
                    'GB',
                    'TB',
                    'PB',
                    'EB',
                    'ZB',
                    'YB'
                ];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            function getDDC(topic) {
                let index = topic.lastIndexOf('/');
                if(index == -1)
                    return "";

                console.log("#### getDDC", index+1, topic.length); 
                console.log("#### getDDC", topic.substring(index+1, topic.length)); 
                return topic.substring(index+1, topic.length);
            }

            function onMessageArrived(message) {
                $('.activity-bar').addClass('hr-green');
                setTimeout(function () {
                    $('.activity-bar').removeClass('hr-green');
                }, 1000);

                // console.log('onMessageArrived:' + message.payloadString);
                console.log('topic is ' + message.destinationName);

                let ddc = getDDC(message.destinationName);
                console.log('ddc is ' + ddc);
                if(ddc != '') {
                    console.log(message);
                }

                let data = "";

                try {
                    data = JSON.parse(message.payloadString);
console.log(data);
                } catch(error) {
                    console.error("JSON parsing error");
                    console.error(message.payloadString);
                    return;
                }

                if (data["timestamp"]) {
                    $('#last_updated_container').html(getTimeagostamp(data["timestamp"]));
                    activateTimeago();
                }

                if(ddc == 'org.homebus.experimental.weather') 
                  onWeather(data); 

                if(ddc == 'org.homebus.experimental.3dprinter')
                  on3DPrinter(data); 

                if(ddc == 'org.homebus.experimental.3dprinter-completed-job') 
                  on3DPrinterJob(data); 

                if(ddc == 'org.homebus.experimental.aqi')
                  onAQI(data); 

                if(ddc == 'org.homebus.experimental.image')
                  onImage(data); 
            }

            function getTimeagostamp(timestamp) {
                var d = new Date(Number(timestamp) * 1000);
                return "<time class='timeago' datetime='" + d.toISOString() + "' title='" + d.toLocaleString() + "'></time>";
            }
            function activateTimeago() {
                $('.timeago').timeago();
            }


            function onWeather(w) {
		let id = '#' + w["id"];
		let data = w["org.homebus.experimental.weather"];

//		alert("weather");

                $(id).text('');

                if (data["conditions_short"]) {
                    $(id).append(data["conditions_short"] + ': ');
                }
                $(id).append(data["temperature"] + "°C, " + data["humidity"] + "%");
                if (data["conditions_long"]) {
                    $(id).append(", " + data["conditions_long"]);
                }
                $(id).append("<br/>" + getTimeagostamp(w["timestamp"]));
                activateTimeago();
            }
            function onAQI(msg) {
                let text = "";
		data = msg["org.homebus.experimental.aqi"];

                data.forEach(function (item, index) {
                    text += item["name"] + " AQI is " + item["aqi"] + " (" + item["condition"] + ")<br />";
                });
                text += getTimeagostamp(msg["timestamp"]);
                $('#aqi').html(text);
                activateTimeago();
            }

            // functions from https://stackoverflow.com/questions/20958078/resize-a-base-64-image-in-javascript-without-using-canvas
            // resize an image using an off-page canvas
            function resizeImage() {
                var newDataUri = imageToDataUri(this, width, height);
            }
            function imageToDataUri(base4_image, width, height) {
                let img = new Image;

                img.onload = resizeImage;
                img.src = 'data:image/jpeg;base64,' + base64_image;
                // create an off-screen canvas
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');
                // set its dimension to target size
                canvas.width = width;
                canvas.height = height;
                // draw source image into the off-screen canvas:
                ctx.drawImage(img, 0, 0, width, height);
                // encode image to data-uri with base64 version of compressed image
                return canvas.toDataURL();
            }
            function onImage(msg) {
                var image;

                console.log('using org.homebus.image'); 
                image = msg['org.homebus.experimental.image']; 
//                console.log(image);

                let data = 'data:' + image['mime_type'] + ';base64,' +image['data'];
                let container = '#' + msg['id'];

                $(container + ' img').attr('src', data);
                $(container + ' a[data-toggle="lightbox"]').attr('href', data);
                $(container + ' time').remove();
                $(container).append(getTimeagostamp(msg['timestamp']));
                activateTimeago();
            }
            // from https://stackoverflow.com/questions/36098913/convert-seconds-to-days-hours-minutes-and-seconds
            function secondsToDhms(seconds) {
                seconds = Number(seconds);
                var d = Math.floor(seconds / (3600*24));
                var h = Math.floor(seconds % (3600*24) / 3600);
                var m = Math.floor(seconds % 3600 / 60);
                var s = Math.floor(seconds % 60);

                var dDisplay = d > 0 ? d + (d == 1 ? " day, " : " days, ") : "";
                var hDisplay = h > 0 ? h + (h == 1 ? " hour, " : " hours, ") : "";
                var mDisplay = m > 0 ? m + (m == 1 ? " minute, " : " minutes, ") : "";
                var sDisplay = s > 0 ? s + (s == 1 ? " second" : " seconds") : "";
                return dDisplay + hDisplay + mDisplay + sDisplay;
            }

            function on3DPrinter(msg) {
 	        let id = '#' + msg["id"];
                let data = msg["org.homebus.experimental.3dprinter"];

                $(id + ' .status').text(data['status']['state']);
                $(id + ' .filename').text(data['job']['file']);
                if(data['job']['progress']) {
                    $(id + ' .print-progress').text(data['job']['progress'].toFixed(2) + '%');
                    $(id + ' .print-progress').attr('aria-valuenow', data['job']['progress'].toFixed(2));
                    $(id + ' .print-progress').css("width", + data['job']['progress'].toFixed(2) + '%');
                }
                $(id + ' .print-time').text(data['job']['print_time']);
                $(id + ' .print-time-remaining').text(data['job']['print_time_remaining']);
                if (data['status']['state'] != 'idle') {
                    $(id + ' .job').show();
                }
                $(id + ' .tool-temp').text(data['temperatures']['tool0_actual']);
                $(id + ' .tool-temp-target').text(data['temperatures']['tool0_target']);
                $(id + ' .bed-temp').text(data['temperatures']['bed_actual']);
                $(id + ' .bed-temp-target').text(data['temperatures']['bed_target']);

                $(id + ' time').remove();
                $(id).append(getTimeagostamp(msg['timestamp']));
                activateTimeago();
            }

            function onSunriseSunset(msg) {
                let data = msg['org.homebus.experimental.solar-clock'];

                let sunrise_date = new Date(data['sunrise']*1000); 
                let sunset_date = new Date(data['sunset']*1000); 

                $('.sunrise').text(sunrise_date.getHours() + ':' + sunrise_date.getMinutes() + 'AM'); 
                $('.sunset').text(sunset_date.getHours() + ':' + sunset_date.getMinutes() + 'PM'); 
            }
        </script>
    </body>
</html>